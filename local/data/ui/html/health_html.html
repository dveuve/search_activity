<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Health | Search Activity | Splunk</title>
    <link rel="shortcut icon" href="{{SPLUNKWEB_URL_PREFIX}}/static/img/favicon.ico" />
    <link rel="stylesheet" type="text/css" href="{{SPLUNKWEB_URL_PREFIX}}/static/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" media="all" href="{{SPLUNKWEB_URL_PREFIX}}/static/css/pages/dashboard-simple-bootstrap.min.css" />
    <!--[if IE 7]><link rel="stylesheet" href="{{SPLUNKWEB_URL_PREFIX}}/static/css/sprites-ie7.css" /><![endif]-->
</head>
<body class="simplexml preload locale-en">

<!-- 
BEGIN LAYOUT
This section contains the layout for the dashboard. Splunk uses proprietary
styles in <div> tags, similar to Bootstrap's grid system. 
-->
<a class="navSkip" href="#navSkip" tabindex="1">Screen reader users, click here to skip the navigation bar</a>
<div class="header">
    <div id="placeholder-splunk-bar">
        <a href="{{SPLUNKWEB_URL_PREFIX}}/app/launcher/home" class="brand" title="splunk &gt; listen to your data">splunk<strong>&gt;</strong></a>
    </div>
    <div id="placeholder-app-bar"></div>
</div>
<a id="navSkip"></a>
<div class="dashboard-body container-fluid main-section-body" data-role="main">
    <div class="dashboard-header clearfix">
        <h2>Searc Activity - Health</h2>
        <p class="description"></p>
    </div>
    <div class="dashboard-row dashboard-row1">
        <div class="dashboard-cell" style="width: 100%;">
            <div class="dashboard-panel clearfix">                
                <div class="panel-element-row">
                
                    <div class="dashboard-element table" id="element1" style="width: 100%">
                      <div class="panel-head">
                        <h3>LDAPSearch Lookup</h3>
                      </div>
                      <div class="panel-body">
                      
                <p>Search Activity is aided substantially by the presence of LDAP information. It is generally most efficient to install SA-LDAPSearch on the same search head as the Search Activity app, but you can also use export a CSV from another search. Ultimately the data we're looking at can be generated by the scheduled search "Generate LDAPSearch Lookup." Take a look at the below to see what you are missing. 
                <ul>
                <li>If you are missing WeHaveData, it means that no LDAPSearch data exists at all. </li>
                <li>If you are missing WeHaveManagers, that means that we didn't find management data in at least 50% of the data. Most organizations will put their org chart information into the manager field in Active Directory. This isn't necessarily the end of the world, but it would be really useful. If this data is defined, but doesn't show up below, double check that it's not present in just a small subset of the data. If it's not defined at all, check the LDAP Attribute coming out of LDAPSearch.</li>
                <li>If you are missing WeHaveTitles, that means we didn't find a title attribute in at least 50% of the data. Similarly to the above, you should check out the title attribute.</li>
                </ul>
                </p>
                <p>Important Note: The Domain used by the SA-LDAPSearch Query is defined by the macro SA-LDAPSearch-Domain.</p></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="dashboard-row dashboard-row2">
        <div class="dashboard-cell" style="width: 100%;">
            <div class="dashboard-panel clearfix">                
                <div class="panel-element-row">
                 
                
                    <div class="dashboard-element table" id="element2" style="width: 100%">
                        <div class="panel-head">
                            <h3>LDAP Management Chain</h3>
                        </div>
                        <div class="panel-body">
                      <p>The LDAP Management Chain information is also very helpful. This piece is easy -- if you have all "Yes" for the above, then you need only run the "Generate LDAPMgmtChain Lookup" search. While you're at it, why don't you schedule that, and also schedule the LDAPSearch!
                <ul>
                <li>If you are missing WeHaveData, it means that no LDAPMgmtChain data exists at all. </li>
                <li>If you are missing WeHaveMChain, you're probably missing something above, or you should check the logic in the search defined by the macro SA-LDAPSearch-Regenerate-LDAPMgmtChain.</li>
                </ul>
                </p>
                      </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="dashboard-row dashboard-row3">
        <div class="dashboard-cell" style="width: 100%;">
            <div class="dashboard-panel clearfix">                
                <div class="panel-element-row">
                
                    <div class="dashboard-element table" id="element3" style="width: 100%">
                        <div class="panel-head">
                            <h3>TSIDX Check</h3>
                        </div>
                        <div class="panel-body">
                      <p>The LDAP Management Chain information is also very helpful. This piece is easy -- if you have all "Yes" for the above, then you need only run the "Generate LDAPMgmtChain Lookup" search. While you're at it, why don't you schedule that, and also schedule the LDAPSearch!
                <ul>
                <li>If you are missing WeHaveData, it means that no LDAPMgmtChain data exists at all. </li>
                <li>If you are missing WeHaveMChain, you're probably missing something above, or you should check the logic in the search defined by the macro SA-LDAPSearch-Regenerate-LDAPMgmtChain.</li>
                </ul>
                </p>
                      </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="dashboard-row dashboard-row4">
        <div class="dashboard-cell" style="width: 100%;">
            <div class="dashboard-panel clearfix">                
                <div class="panel-element-row">
                <h3>Raw Events Check</h3>
               
                    <div class="dashboard-element table" id="element4" style="width: 100%">
                        <div class="panel-head">
                            <h3>App Dependencies</h3>
                        </div>
                        <div class="panel-body">
                       <p>The below are reporting on the matching of raw data. Effectively, this is checking whether your macros are set properly to recognize events.
                    <ul>
                        <li>If you are missing WeHaveEvents, you should check the following macros:
                            <ul>
                                <li>FillEvents_Search - This actually generates the data (and is the basis of the below).</li>
                                <li>internal_index - Defines the location of the required data. This will almost always be _internal.</li>
                                <li>metrics_sourcetype - Defines the sourcetype for metrics.log. This will almost always be metrics.</li>
                                <li>scheduler_sourcetype - Defines the sourcetype of scheduler.log. This will almost always be scheduler.</li>
                                <li>web_access_sourcetype - Defines the sourcetype of web_access.log. This will almost always be splunk_web_access.</li>
                            </ul>
                        </li>
                        <li>If you are missing WeHaveSearchData, you should check the following macros: 
                            <ul>
                                <li>FillSearchHistory_Search - This actually generates the data (and is the basis of the below).</li>
                                <li>auditindex - Defines the location of the required data. This will almost always be _audit.</li>
                                <li>auditsourcetype - Defines the sourcetype for audit.log. This will almost always be audittrail.</li>
                            </ul>
                        </li>
                    </ul>
                </p></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="dashboard-row dashboard-row5">
        <div class="dashboard-cell" style="width: 100%;">
            <div class="dashboard-panel clearfix">                
                <div class="panel-element-row">

                
                    <div class="dashboard-element table" id="element5" style="width: 100%">
                        <div class="panel-head">
                            <h3>App Dependencies</h3>
                        </div>
                        <div class="panel-body"><p>This is mostly a placeholder to show whether SA-LDAPSearch is present. Eventually, it should be expanded to check for potential sources of conflict (SA-Utils, splunk_app_for_vmware), should that code branch be successful.
                </p></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="dashboard-row dashboard-row6">
        <div class="dashboard-cell" style="width: 100%;">
            <div class="dashboard-panel clearfix">                
                <div class="panel-element-row">
                    <div class="dashboard-element table" id="element6" style="width: 100%">
                        <div class="panel-head">
                            <h3>TSIDX Size</h3>
                        </div>
                        <div class="panel-body"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="footer"></div>

<!-- 
END LAYOUT
-->

<script src="{{SPLUNKWEB_URL_PREFIX}}/config?autoload=1"></script>
<script src="{{SPLUNKWEB_URL_PREFIX}}/static/js/i18n.js"></script>
<script src="{{SPLUNKWEB_URL_PREFIX}}/i18ncatalog?autoload=1"></script>
<script src="{{SPLUNKWEB_URL_PREFIX}}/static/js/build/simplexml.min/config.js"></script>
<script type="text/javascript">
require.config({
    baseUrl: "{{SPLUNKWEB_URL_PREFIX}}/static/js",
    waitSeconds: 0 // Disable require.js load timeout
});

//
// LIBRARY REQUIREMENTS
//
// In the require function, we include the necessary libraries and modules for
// the HTML dashboard. Then, we pass variable names for these libraries and
// modules as function parameters, in order.
// 
// When you add libraries or modules, remember to retain this mapping order
// between the library or module and its function parameter. You can do this by
// adding to the end of these lists, as shown in the commented examples below.

require([
    "splunkjs/mvc",
    "splunkjs/mvc/utils",
    "splunkjs/mvc/tokenutils",
    "underscore",
    "jquery",
    "splunkjs/mvc/simplexml",
    "splunkjs/mvc/headerview",
    "splunkjs/mvc/footerview",
    //"splunkjs/mvc/simplexml/dashboardview",
    "splunkjs/mvc/simplexml/dashboard",
    "splunkjs/mvc/simplexml/element/chart",
    "splunkjs/mvc/simplexml/element/event",
    "splunkjs/mvc/simplexml/element/html",
    "splunkjs/mvc/simplexml/element/list",
    "splunkjs/mvc/simplexml/element/map",
    "splunkjs/mvc/simplexml/element/single",
    "splunkjs/mvc/simplexml/element/table",
    //"splunkjs/mvc/simpleform/formutils",
    "splunkjs/mvc/simpleform/input/dropdown",
    "splunkjs/mvc/simpleform/input/radiogroup",
    "splunkjs/mvc/simpleform/input/text",
    "splunkjs/mvc/simpleform/input/timerange",
    "splunkjs/mvc/simpleform/input/submit",
    "splunkjs/mvc/searchmanager",
    "splunkjs/mvc/savedsearchmanager",
    "splunkjs/mvc/postprocessmanager",
    "splunkjs/mvc/simplexml/urltokenmodel"
    // Add comma-separated libraries and modules manually here, for example:
    // ..."splunkjs/mvc/simplexml/urltokenmodel",
    // "splunkjs/mvc/checkboxview"
    ],
    function(
        mvc,
        utils,
        TokenUtils,
        _,
        $,
        DashboardController,
        HeaderView,
        FooterView,
        Dashboard,
        ChartElement,
        EventElement,
        HtmlElement,
        ListElement,
        MapElement,
        SingleElement,
        TableElement,
      //  FormUtils,
        DropdownInput,
        RadioGroupInput,
        TextInput,
        TimeRangeInput,
        SubmitButton,
        SearchManager,
        SavedSearchManager,
        PostProcessManager,
        UrlTokenModel

        // Add comma-separated parameter names here, for example: 
        // ...UrlTokenModel, 
        // CheckboxView
        ) {



        var pageLoading = true;


        // 
        // TOKENS
        //
        
        // Create token namespaces
        var urlTokenModel = new UrlTokenModel();
        mvc.Components.registerInstance('url', urlTokenModel);
        var defaultTokenModel = mvc.Components.getInstance('default', {create: true});
        var submittedTokenModel = mvc.Components.getInstance('submitted', {create: true});

        urlTokenModel.on('url:navigate', function() {
            defaultTokenModel.set(urlTokenModel.toJSON());
            if (!_.isEmpty(urlTokenModel.toJSON()) && !_.all(urlTokenModel.toJSON(), _.isUndefined)) {
                submitTokens();
            } else {
                submittedTokenModel.clear();
            }
        });


        // Initialize tokens
        defaultTokenModel.set(urlTokenModel.toJSON());

        var defaultUpdate = {};

        var submitTokens = function() {
            submitTokensSoon(pageLoading);
        };

        var submitTokensSoon = _.debounce(function(replaceState) {
            submittedTokenModel.set(defaultTokenModel.toJSON());
            urlTokenModel.saveOnlyWithPrefix('form\\.', defaultTokenModel.toJSON(), {
                replaceState: replaceState
            });
        });

/*
        function submitTokens() {
            // Copy the contents of the defaultTokenModel to the submittedTokenModel and urlTokenModel
            FormUtils.submitForm({ replaceState: pageLoading });
        }
        function setToken(name, value) {
            defaultTokenModel.set(name, value);
            submittedTokenModel.set(name, value);
        }

        function unsetToken(name) {
            defaultTokenModel.unset(name);
            submittedTokenModel.unset(name);
        }
*/
        //
        // SEARCH MANAGERS
        //

        var search1 = new SearchManager({
            "id": "search1",
            "status_buckets": 0,
            "search": "| inputlookup LDAPSearch | stats count count(eval(len(title)>1)) as NumWithTitle count(eval(len(manager)>1)) as NumWithManager | eval Threshold=0.5 | eval WeHaveData=if(count>1,\"Yes\",\"No\") | eval WeHaveTitles=if(NumWithTitle/count>Threshold,\"Yes\",\"No\")| eval WeHaveManagers=if(NumWithManager/count>Threshold,\"Yes\",\"No\") | fields We*",
            "latest_time": "",
            "cancelOnUnload": true,
            "earliest_time": "",
            "app": utils.getCurrentApp(),
            "auto_cancel": 90,
            "preview": true,
            "runWhenTimeIsUndefined": false
        }, {tokens: true, tokenNamespace: "submitted"});

        var search2 = new SearchManager({
            "id": "search2",
            "status_buckets": 0,
            "search": "| inputlookup LDAPMgmtChain | stats count count(eval(len(ManagementChain)>1)) as NumWithMChain  | eval Threshold=0.5 | eval WeHaveData=if(count>1,\"Yes\",\"No\") | eval WeHaveMChain=if(NumWithMChain/count>Threshold,\"Yes\",\"No\") | fields We*",
            "latest_time": "",
            "cancelOnUnload": true,
            "earliest_time": "",
            "app": utils.getCurrentApp(),
            "auto_cancel": 90,
            "preview": true,
            "runWhenTimeIsUndefined": false
        }, {tokens: true, tokenNamespace: "submitted"});

        var search3 = new SearchManager({
            "id": "search3",
            "status_buckets": 0,
            "search": "| tstats local=t count as SearchHistory dc(NumExports) as NumExports dc(searchspan_s) as searchspan_s dc(searchspan_m) as searchspan_m dc(searchspan_h) as searchspan_h dc(searchspan_d) as searchspan_d dc(total_run_time) as total_run_time dc(result_count) as result_count dc(scan_count) as scan_count dc(searchtype) as searchtype dc(search_status) as search_status dc(savedsearch_name) as savedsearch_name dc(searchcommands) as searchcommands dc(user) as user dc(ManagerDN) as ManagerDN dc(email) as email dc(distinguishedName) as distinguishedName dc(earliest) as earliest dc(latest) as latest dc(name) as name dc(NumDirectReports) as NumDirectReports dc(description) as description dc(city) as city dc(location) as location dc(organization) as organization dc(state) as state dc(title) as title dc(ManagementChain) as ManagementChain dc(ManagerName) as ManagerName dc(Accuracy) as Accuracy dc(WasShared) as WasShared from `SA_SearchHistory` | eval SA_SH_Version = case((Accuracy > 0) AND (earliest>0),\"1.2\", Accuracy>0,\"1.1\", 1=1,\"1.0\") | fields SearchHistory SA_SH_Version | join [|  tstats local=t count as Events from `SA_Events` | eval SA_Events_Version = \"1.0-1.2 (No Changes)\"] | eval WeHaveSearchHistoryTSIDX=if(SearchHistory>10,\"Yes\",\"No\") | eval WeHaveEventsTSIDX=if(Events>10,\"Yes\",\"No\") | fields We* *Version",
            "latest_time": "",
            "cancelOnUnload": true,
            "earliest_time": "",
            "app": utils.getCurrentApp(),
            "auto_cancel": 90,
            "preview": true,
            "runWhenTimeIsUndefined": false
        }, {tokens: true, tokenNamespace: "submitted"});

        var search4 = new SearchManager({
            "id": "search4",
            "status_buckets": 0,
            "search": "`FillSearchHistory_Search` | stats count as SearchHistory | append [search `FillEvents_Search` | stats count as Events] | stats sum(SearchHistory) as SearchHistory sum(Events) as Events | eval WeHaveSearchData = if(SearchHistory>10,\"Yes\",\"No\") | eval WeHaveEvents = if(Events>10,\"Yes\",\"No\") | fields We*",
            "latest_time": "now",
            "cancelOnUnload": true,
            "earliest_time": "-60m@m",
            "app": utils.getCurrentApp(),
            "auto_cancel": 90,
            "preview": true,
            "runWhenTimeIsUndefined": false
        }, {tokens: true, tokenNamespace: "submitted"});

        var search5 = new SearchManager({
            "id": "search5",
            "status_buckets": 0,
            "search": "| rest \"/services/apps/local\" | stats count(eval(title=\"SA-LDAPSearch\")) as IsLDAPSearchInstalled values(eval(if(title=\"SA-LDAPSearch\",version,null))) as LDAPSearchVersion values(eval(if(title=\"search_activity\",version,null))) as search_activity_Version",
            "latest_time": "now",
            "cancelOnUnload": true,
            "earliest_time": "-60m@m",
            "app": utils.getCurrentApp(),
            "auto_cancel": 90,
            "preview": true,
            "runWhenTimeIsUndefined": false
        }, {tokens: true, tokenNamespace: "submitted"});
  
  		var search6 = new SearchManager({
            "id": "search6",
            "status_buckets": 0,
            "search": "|listsanamespaces | eval \"Size (MB)\" = size/1024/1024 | fields namespace \"Size (MB)\"",
            "latest_time": "now",
            "cancelOnUnload": true,
            "earliest_time": "-60m@m",
            "app": utils.getCurrentApp(),
            "auto_cancel": 90,
            "preview": true,
            "runWhenTimeIsUndefined": false
        }, {tokens: true, tokenNamespace: "submitted"});



        //
        // SPLUNK HEADER AND FOOTER
        //

        new HeaderView({
            id: 'header',
            section: 'dashboards',
            el: $('.header'),
            acceleratedAppNav: true,
            useSessionStorageCache: true
        }, {tokens: true}).render();

        new FooterView({
            id: 'footer',
            el: $('.footer')
        }, {tokens: true}).render();


        //
        // DASHBOARD EDITOR
        //

        new Dashboard({
            id: 'dashboard',
            el: $('.dashboard-body')
        }, {tokens: true}).render();


        //
        // VIEWS: VISUALIZATION ELEMENTS
        //

        var element1 = new TableElement({
            "id": "element1",
            "managerid": "search1",
            "el": $('#element1')
        }, {tokens: true}).render();
        
        var element2 = new TableElement({
            "id": "element2",
            "managerid": "search2",
            "el": $('#element2')
        }, {tokens: true}).render();
        
        var element3 = new TableElement({
            "id": "element3",
            "managerid": "search3",
            "el": $('#element3')
        }, {tokens: true}).render();
        
        var element4 = new TableElement({
            "id": "element4",
            "managerid": "search4",
            "el": $('#element4')
        }, {tokens: true}).render();
        
        var element5 = new TableElement({
            "id": "element5",
            "managerid": "search5",
            "el": $('#element5')
        }, {tokens: true}).render();
        
        var element6 = new ChartElement({
            "id": "element6",
    		"charting.chart": "bar",
            "managerid": "search6",
            "el": $('#element6')
        }, {tokens: true}).render();
        

        // Initialize time tokens to default
        if (!defaultTokenModel.has('earliest') && !defaultTokenModel.has('latest')) {
            defaultTokenModel.set({ earliest: '0', latest: '' });
        }

        submitTokens();


        //
        // DASHBOARD READY
        //

        DashboardController.ready();
        pageLoading = false;

    }
);
</script>
</body>
</html>
